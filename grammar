// Missing:
// - condition, math expressions
// - match
// - enum & struct declaration
// - namespaces & packages
// - binary operations on enums
// - function composition?
// Problem:
// - rval is too broad: creates circular def

program:
  %empty
  | block
  ;

block:
  stmts rval
  ;
  
stmts:
  stmt
  | stmts stmt
  ;

stmt:
  LET lval ASSIGN rval SEMICOLON
  | rval SEMICOLON
  ;

lval:
  IDENTIFIER
  | IDENTIFIER COLON type
  ;

type:
  IDENTIFIER
  | INTEGER_TYPE
  | STRING_TYPE
  | FLOAT_TYPE
  | BOOL_TYPE
  | PATH_TYPE
  | DURATION_TYPE
  | TIMESTAMP_TYPE
  | SCHEDULE_TYPE
  | compound_type
  ;

compound_type:
  advanced_types LESS_THAN types GREATER_THAN

advanced_types:
  RESULT_TYPE
  | OPTION_TYPE
  | ASYNC_TYPE
  | OBJECT_TYPE
  | LIST_TYPE

types:
  type
  | types COMMA type
  ;

rval:
  // Values
  function
  | list
  | object
  | INTEGER
  | STRING
  | PATH
  | FLOAT
  | TRUE_VAL
  | FALSE_VAL
  // Expressions
  | IDENTIFIER
  | function_call
  | list_get
  | object_get
  | if_expr
  | pipe_expr
  ;

// Value rules

function:
  function_args_par ARROW function_body
  | function_args_par ARROW type function_body
  ;

function_args_par:
  function_args
  | LPAR function_args RPAR
  ;

function_args:
  %empty
  | lval
  | function_args COMMA lval
  ;

function_body:
  LBRACE block RBRACE
  | rval
  ;

list:
  LBRACKET list_args RBRACKET
  ;

list_args:
  %empty
  | rval
  | list_args COMMA rval
  ;

object:
  LBRACE object_args RBRACE
  ;

object_args:
  %empty
  | object_arg
  | object_args COMMA object_arg
  ;
  
object_arg:
  IDENTIFIER ASSIGN rval
  ;

// Expression rules

function_call:
  IDENTIFIER pos_args key_args
  | IDENTIFIER LPAR pos_args key_args RPAR
  ;

pos_args:
  %empty
  | rval
  | pos_args COMMA rval
  ;

key_args:
  %empty
  | key_arg
  | key_args COMMA key_arg
  ;

key_arg:
  IDENTIFIER ASSIGN rval
  ;
  
list_get:
  IDENTIFIER LBRACKET INTEGER RBRACKET
  ;

object_get:
  IDENTIFIER DOT IDENTIFIER
  ;

if_expr:
  IF condition if_body else_if_list
  | IF condition if_body else_if_list ELSE else_body
  ;

if_body:
  LBRACE block RBRACE
  | THEN rval
  ;

else_if_list:
  %empty
  | else_if
  | else_if_list else_if
  ;

else_if:
  ELSE IF condition if_body
  ;

else_body:
  LBRACE block RBRACE
  | rval
  ;

pipe_expr:
  pipe_term
  | pipe_expr PIPE pipe_term
  ;

pipe_term:
  function_call
  | rval
  ;

